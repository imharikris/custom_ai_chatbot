FastAPI – Python Web Framework 29. FASTAPI – FASTAPI EVENT HANDLERS ..................................................... 106 30. FASTAPI – MOUNTING A SUB-APP ........................................................... 108 31. FASTAPI – MIDDLEWARE ......................................................................... 111 32. FASTAPI – MOUNTING FLASK APP ........................................................... 113 33. FASTAPI – DEPLOYMENT ......................................................................... 115 iv
1. FastAPI – InFtasrtoAPdI –u Pcytthioon Wne b Framework FastAPI is a modern Python web framework, very efficient in building APIs. It is based on Python’s type hints feature that has been added since Python 3.6 onwards. It is one of the fastest web frameworks of Python.  As it works on the functionality of Starlette and Pydantic libraries, its performance is amongst the best and on par with that of NodeJS and Go.  In addition to offering high performance, FastAPI offers significant speed for development, reduces human-induced errors in the code, is easy to learn and is completely production-ready.  FastAPI is fully compatible with well-known standards of APIs, namely OpenAPI and JSON schema. FastAPI has been developed by Sebastian Ramirez in Dec. 2018. FastAPI 0.68.0 is the currently available version. FastAPI – Environment Setup To install FastAPI (preferably in a virtual environment), use pip installer. pip3 install fastapi FastAPI depends on Starlette and Pydantic libraries, hence they also get installed. Installing Uvicorn using PIP FastAPI doesn’t come with any built-in server application. To run FastAPI app, you need an ASGI server called uvicorn, so install the same too, using pip installer. It will also install uvicorn’s dependencies - asgiref, click, h11, and typing-extensions pip3 install uvicorn With these two libraries installed, we can check all the libraries installed so far. 1
FastAPI – Python Web Framework pip3 freeze asgiref==3.4.1 click==8.0.1 colorama==0.4.4 fastapi==0.68.0 h11==0.12.0 importlib-metadata==4.6.4 pydantic==1.8.2 starlette==0.14.2 typing-extensions==3.10.0.0 uvicorn==0.15.0 zipp==3.5.0 2
2. FastAPI – HFeasltlAoPI –W Pyothornl dWe b Framework Getting Started The first step in creating a FastAPI app is to declare the application object of FastAPI class. from fastapi import FastAPI app = FastAPI() This app object is the main point of interaction of the application with the client browser. The uvicorn server uses this object to listen to client’s request. The next step is to create path operation. Path is a URL which when visited by the client invokes visits a mapped URL to one of the HTTP methods, an associated function is to be executed. We need to bind a view function to a URL and the corresponding HTTP method. For example, the index() function corresponds to ‘/’ path with ‘get’ operation. @app.get("/") async def root(): return {"message": "Hello World"} The function returns a JSON response, however, it can return dict, list, str, int, etc. It can also return Pydantic models. Save the following code as main.py from fastapi import FastAPI app = FastAPI() @app.get("/") async def index(): return {"message": "Hello World"} 3
FastAPI – Python Web Framework Start the uvicorn server by mentioning the file in which the FastAPI application object is instantiated. uvicorn main:app --reload INFO: Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit) INFO: Started reloader process [28720] INFO: Started server process [28722] INFO: Waiting for application startup. INFO: Application startup complete. Open the browser and visit http://localhost:/8000. You will see the JSON response in the browser window. 4
3. FastAPI – FOastpAPeI –n PAythPonI Web Framework Enter the following URL in the browser to generate automatically the interactive documentation. http://127.0.0.1:8000/docs FastAPI uses Swagger UI to produce this documentation. The browser will display the following: 5
FastAPI – Python Web Framework Click the 'try it out' button and then 'Execute' button that appears afterward. You can see the Curl command internally executed, the request URL, the response headers, and the JSON format of the server’s response. FastAPI generates a schema using OpenAPI specifications. The specification determines how to define API paths, path parameters, etc. The API schema defined by the OpenAPI standard decides how the data is sent 6
FastAPI – Python Web Framework using JSON Schema. Visit http://127.0.0.1:8000/openapi.json from your browser. A neatly formatted JSON response as follows will be displayed: { "openapi": "3.0.2", "info": { "title": "FastAPI", "version": "0.1.0" }, "paths": { "/": { "get": { "summary": "Index", "operationId": "index__get", "responses": { "200": { "description": "Successful Response", "content": { "application/json": { "schema": {} } } } } } } } } FastAPI also supports another automatic documentation method provided by Redoc (https://github.com/Redocly/redoc). 7
FastAPI – Python Web Framework Enter http://localhost:8000/redoc as URL in the browser’s address bar. 8
4. FastAPI –F aUstAvPIi c– oPyrthnon Web Framework Unlike the Flask framework, FastAPI doesn’t contain any built-in development server. Hence we need Uvicorn. It implements ASGI standards and is lightning fast. ASGI stands for Asynchronous Server Gateway Interface. The WSGI (Web Server Gateway Interface – the older standard) compliant web servers are not suitable for asyncio applications. Python web frameworks (such as FastAPI) implementing ASGI specifications provide high speed performance, comparable to web apps built with Node and Go. Uvicorn uses uvloop and httptools libraries. It also provides support for HTTP/2 and WebSockets, which cannot be handled by WSGI. uvloop id similar to the built-in asyncio event loop. httptools library handles the http protocols. The installation of Uvicorn as described earlier will install it with minimal dependencies. However, standard installation will also install cython based dependencies along with other additional libraries. pip3 install uvicorn(standard) With this, the WebSockets protocol will be supported. Also, PyYAML will be installed to allow you to provide a .yaml file. As mentioned earlier, the application is launched on the Uvicorn server with the following command: uvicorn main:app –reload The --reload option enables the debug mode so that any changes in app.py will be automatically reflected and the display on the client browser will be automatically refreshed. In addition, the following command-line options may be used: --host TEXT B i nd socket to this host. [default 127.0.0.1] --port INTEGER B i n d socket to this port. [default 8000] --uds TEXT B i nd to a UNIX domain socket. --fd INTEGER B i n d to socket from this file descriptor. --reload Enable auto-reload. 9
FastAPI – Python Web Framework Set reload directories explicitly, default --reload-dir PATH current working directory. Include files while watching. Includes '*.py' by --reload-include TEXT default -reload-exclude TEXT E x c lu de while watching for files. Delay between previous and next check default --reload-delay FLOAT 0.25 -loop Event loop implementation. [default auto] [auto|asyncio|uvloop] --http HTTP protocol implementation. [default auto] [auto|h11|httptools] --interface Select application interface. [default auto] auto|asgi|asgi|wsgi --env-file PATH E n vironment configuration file. Logging configuration file. Supported formats --log-config PATH .ini, .json, .yaml. --version D isplay the uvicorn version and exit. Look for APP in the specified directory default --app-dir TEXT current directory --help Show this message and exit. Instead of starting Uvicorn server from command line, it can be launched programmatically also. Example In the Python code, call uvicorn.run() method, using any of the parameters listed above: import uvicorn from fastapi import FastAPI app = FastAPI() @app.get("/") 10
FastAPI – Python Web Framework async def index(): return {"message": "Hello World"} if __name__ == "__main__": uvicorn.run("main:app", host="127.0.0.1", port=8000, reload=True) Now run this app.py as Python script as follows: (fastapienv) C:\fastapienv>python app.py Uvicorn server will thus be launched in debug mode. 11
5. FastAPI – TFaystpAPeI –H Pyitnhotns W eb Framework FastAPI makes extensive use of the Type hinting feature made available in Python’s version 3.5 onwards. As a matter of fact, Python is known to be a dynamically typed language. It also happens to be Python’s distinct feature. In a Python code, a variable need not be declared to be belonging to a certain type, and its type is determined dynamically by the instantaneous value assigned to it. Python’s interpreter doesn’t perform type checks and hence it is prone to runtime exceptions. In the following example, a division() function is defined with two parameters and returns their division, assuming that the parameters will be numeric. >>> def division(a, b): return a/b >>> division(10, 4) 2.5 >>> division(10, 2.5) 4.0 However, if one of the values passed to the function happen to be non- numeric, it results in TypeError as shown below: >>> division("Python",5) TypeError: unsupported operand type(s) for /: 'str' and 'int' Even a basic coding environment such as IDLE indicates that the function requires two parameters but won’t specify the types as they haven’t been declared. 12
FastAPI – Python Web Framework Python’s new type hinting feature helps in prompting the user with the expected type of the parameters to be passed. This is done by adding a colon and data type after the parameter. We’ll redefine the division() function as follows: Note that while calling the function, Python hints at the expected type of each parameter to be passed. However, this doesn’t prevent the TypeError from appearing if an incompatible value is passed. You will have to use a static type checker such as MyPy to check for compatibility before running. Just as the formal parameters in the function’s definition, it is possible to provide type hint for a function’s return value. Just before the colon symbol in the function’s definition statement (after which the function block starts) add an arrow (->) and the type. However, as mentioned earlier, if incompatible values are passed to the function, or returned by the function, Python reports TypeError. Use of MyPy static type checker can detect such errors. Install mypy package first. 13
FastAPI – Python Web Framework pip3 install mypy Save the following code as typecheck.py def division(x:int, y:int) -> int: return (x//y) a=division(10,2) print (a) b=division(5,2.5) print (b) c=division("Hello",10) print (c) Check this code for type errors using mypy. C:\python37>mypy typechk.py typechk.py:7: error: Argument 2 to "division" has incompatible type "float"; expected "int" typechk.py:10: error: Argument 1 to "division" has incompatible type "str"; expected "int" Found 2 errors in 1 file (checked 1 source file) There are errors in second and third calls to the function. In second, value passed to y is float when int is expected. In third, value passed to x is str when int is expected. (Note that // operator returns integer division) All standard data types can be used as type hints. This can be done with global variables, variables as function parameters, inside function definition etc. x: int = 3 y: float = 3.14 14
FastAPI – Python Web Framework nm: str = 'abc' married: bool = False names: list = ['a', 'b', 'c'] marks: tuple = (10, 20, 30) marklist: dict = {'a': 10, 'b': 20, 'c': 30} A new addition in newer versions of Python (version 3.5 onwards) standard library is the typing module. It defines special types for corresponding standard collection types. The types on typing module are List, Tuple, Dict, and Sequence. It also consists of Union and Optional types. Note that standard names of data types are all in small case, whereas ones in typing module have first letter in upper case. Using this feature, we can ask a collection of a particular type. from typing import List, Tuple, Dict # following line declares a List object of strings. # If violated, mypy shows error cities: List[str] = ['Mumbai', 'Delhi', 'Chennai'] # This is Tuple with three elements respectively # of str, int and float type) employee: Tuple[str, int, float] = ('Ravi', 25, 35000) # Similarly in the following Dict, the object key should be str # and value should be of int type, failing which # static type checker throws error marklist: Dict[str, int] = {'Ravi': 61, 'Anil': 72} 15
6. FastAPI – IDFaEst ASPIu – pPypthoonr Wte b Framework The Type Hinting feature of Python is most effectively used in almost all IDEs (Integrated Development Environments) such as PyCharm and VS Code to provide dynamic autocomplete features. Let us see how VS Code uses the type hints to provide autocomplete suggestions while writing a code. In the example below, a function named as sayhello with name as an argument has been defined. The function returns a string by concatenating “Hello” to the name parameter by adding a space in between. Additionally, it is required to ensure that the first letter of the name be in upper case. Python’s str class has a capitalize() method for the purpose, but if one doesn’t remember it while typing the code, one has to search for it elsewhere. If you give a dot after name, you expect the list of attributes but nothing is shown because Python doesn’t know what will be the runtime type of name variable. Here, type hint comes handy. Include str as the type of name in the function definition. Now when you press dot (.) after name, a drop down list of all string methods appears, from which the required method (in this case capitalize()) can be picked. 16
FastAPI – Python Web Framework It is also possible to use type hints with a user defined class. In the following example a rectangle class is defined with type hints for arguments to the __init__() constructor. class rectangle: def __init__(self, w:int, h:int) ->None: self.width=w self.height=h Following is a function that uses an object of above rectangle class as an argument. The type hint used in the declaration is the name of the class. def area(r:rectangle)->int: return r.width*r.height r1=rectangle(10,20) print ("area = ", area(r1)) In this case also, the IDE editor provides autocomplete support prompting list of the instance attributes. Following is a screenshot of PyCharm editor. 17
FastAPI – Python Web Framework FastAPI makes extensive use of the type hints. This feature is found everywhere, such as path parameters, query parameters, headers, bodies, dependencies, etc. as well as validating the data from the incoming request. The OpenAPI document generation also uses type hints. 18
7. FastAPI – RESTFa sAtArPIc –h Piyttheocn tWuebr Fera mework RElational State Transfer (REST) is a software architectural style. REST defines how the architecture of a web application should behave. It is a resource based architecture where everything that the REST server hosts, (a file, an image, or a row in a table of a database), is a resource, having many representations. REST recommends certain architectural constraints.  Uniform interface  Statelessness  Client-server  Cacheability  Layered system  Code on demand REST constraints has the following advantages:  Scalability  Simplicity  Modifiability  Reliability  Portability  Visibility REST uses HTTP verbs or methods for the operation on the resources. The POST, GET, PUT and DELETE methods perform respectively CREATE, READ, UPDATE and DELETE operations respectively. 19
8. FastAPI – PathFa sPtAaPI r–a Pmythoen tWeebr sFr amework Modern web frameworks use routes or endpoints as a part of URL instead of file-based URLs. This helps the user to remember the application URLs more effectively. In FastAPI, it is termed a path. A path or route is the part of the URL trailing after the first ‘/’. For example, in the following URL, http://localhost:8000/hello/TutorialsPoint the path or the route would be /hello/TutorialsPoint In FastAPI, such a path string is given as a parameter to the operation decorator. The operation here refers to the HTTP verb used by the browser to send the data. These operations include GET, PUT, etc. The operation decorator (for example, @app.get("/")) is immediately followed by a function that is executed when the specified URL is visited. In the below example: from fastapi import FastAPI app = FastAPI() @app.get("/") async def index(): return {"message": "Hello World"} Here, ("/") is the path, get is the operation, @app.get("/") is the path operation decorator, and the index() function just below it is termed as path operation function. Any of the following HTTP verbs can be used as operations. Sends data in unencrypted form to the server. Most GET common method. HEAD Same as GET, but without the response body. 20
FastAPI – Python Web Framework Used to send HTML form data to the server. Data received POST by the POST method is not cached by the server. Replaces all current representations of the target resource PUT with the uploaded content. Removes all current representations of the target resource DELETE given by a URL. The async keyword in the function’s definition tells FastAPI that it is to be run asynchronously i.e. without blocking the current thread of execution. However, a path operation function can be defined without the async prefix also. This decorated function returns a JSON response. Although it can return almost any of Python’s objects, it will be automatically converted to JSON. Further in this tutorial, we shall see how such a function returns Pydantic model objects. The URL’s endpoint or path can have one or more variable parameters. They can be accepted by using Python’s string formatting notation. In the above example URL http://localhost:8000/hello/TutorialsPoint, the last value may change in every client request. This variable parameter can be accepted in a variable as defined in the path and passed to the formal parameters defined in the function bound to the operation decorator. Example Add another path decorator with a variable parameter in the route, and bind hello() function to have name parameter. Modify the main.py as per the following. import uvicorn from fastapi import FastAPI app = FastAPI() @app.get("/") async def index(): return {"message": "Hello World"} @app.get("/hello/{name}") 21
FastAPI – Python Web Framework async def hello(name): return {"name": name} Start the Uvicorn server and visit http://localhost:8000/hello/Tutorialspoint URL. The browser shows the following JSON response. {"name":"Tutorialspoint"} Change the variable path parameter to something else such as http://localhost:8000/hello/Python so that the browser shows: {"name":"Python"} Check OpenAPI docs Now if we check the OpenAPI documentation by entering the URL as http://localhost:8000/docs, it will show two routes and their respective view functions. Click the try out button below /hello/{name} button and give Tutorialspoint as the value of the name parameter’s description and then click the Execute button. 22
FastAPI – Python Web Framework It will then show the Curl command, the request URL and the details of server’s response with response body and response headers. 23
FastAPI – Python Web Framework A route can have multiple parameters separated by "/" symbol. from fastapi import FastAPI app = FastAPI() @app.get("/hello/{name}/{age}") async def hello(name,age): 24